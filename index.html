<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨˜å¸³å°å¹«æ‰‹ | ç™»å…¥</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin:0; font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; justify-content: center; align-items: center; }
        .card { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        h1 { margin: 0 0 20px 0; color: #333; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        button:hover { background: #5a6fd6; }
        button.secondary { background: white; color: #667eea; border: 1px solid #667eea; }
        .toggle-text { margin-top: 15px; font-size: 14px; color: #666; cursor: pointer; text-decoration: underline; }
        
        /* Loading é®ç½© */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 999; color: white; flex-direction: column; }
        .spinner { width: 30px; height: 30px; border: 4px solid #fff; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div><div>è™•ç†ä¸­...</div></div>

    <div class="card">
        <h1>ğŸ’° è¨˜å¸³ç™»å…¥</h1>
        
        <div id="form-login">
            <input type="text" id="l_acc" placeholder="å¸³è™Ÿ">
            <input type="password" id="l_pwd" placeholder="å¯†ç¢¼">
            <button onclick="doLogin()">ç™»å…¥</button>
            <div class="toggle-text" onclick="toggleMode(false)">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</div>
        </div>

        <div id="form-reg" style="display:none;">
            <input type="text" id="r_acc" placeholder="è¨­å®šå¸³è™Ÿ (å«æ•¸å­—)">
            <input type="password" id="r_pwd" placeholder="è¨­å®šå¯†ç¢¼ (å«æ•¸å­—)">
            <input type="text" id="r_name" placeholder="æ‚¨çš„æš±ç¨±">
            <button onclick="doRegister()">è¨»å†Šå¸³è™Ÿ</button>
            <button class="secondary" onclick="toggleMode(true)">è¿”å›ç™»å…¥</button>
        </div>
    </div>

    <script>
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ âš ï¸
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz8-1i4zy20ChiZm1lzafRQo18iTiHN0eYzQnj-B3dQY8AjUgMnyEsEdlwmVV516K2V/exec";

        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼Œè‹¥æœ‰å‰‡ç›´æ¥è·³è½‰
        if(localStorage.getItem('acc') && localStorage.getItem('name')) {
            window.location.href = 'main.html';
        }

        function toggleMode(isLogin) {
            document.getElementById('form-login').style.display = isLogin ? 'block' : 'none';
            document.getElementById('form-reg').style.display = isLogin ? 'none' : 'block';
        }

        async function doLogin() {
            let acc = document.getElementById('l_acc').value;
            let pwd = document.getElementById('l_pwd').value;
            if(!acc || !pwd) return alert('è«‹è¼¸å…¥å®Œæ•´');

            let res = await callApi({ action: 'login', account: acc, password: pwd });
            if(res.success) {
                // å„²å­˜ç™»å…¥è³‡è¨Šåˆ°ç€è¦½å™¨
                localStorage.setItem('acc', res.account);
                localStorage.setItem('name', res.username);
                // è·³è½‰é é¢
                window.location.href = 'main.html';
            } else {
                alert(res.msg);
            }
        }

        async function doRegister() {
            let acc = document.getElementById('r_acc').value;
            let pwd = document.getElementById('r_pwd').value;
            let name = document.getElementById('r_name').value;
            if(!acc || !pwd || !name) return alert('è«‹è¼¸å…¥å®Œæ•´');

            let res = await callApi({ action: 'register', account: acc, password: pwd, username: name }, 'POST');
            if(res.success) {
                alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
                toggleMode(true);
            } else {
                alert(res.msg);
            }
        }

        async function callApi(params, method='GET') {
            document.getElementById('loading').style.display = 'flex';
            try {
                let url = GAS_URL;
                let opts = { method: method };
                if(method === 'GET') {
                    url += '?' + new URLSearchParams(params).toString();
                } else {
                    opts.body = JSON.stringify(params);
                    // é—œéµï¼šä½¿ç”¨ text/plain é¿é–‹ CORS æª¢æŸ¥
                    opts.headers = { "Content-Type": "text/plain;charset=utf-8" };
                }
                let req = await fetch(url, opts);
                let json = await req.json();
                document.getElementById('loading').style.display = 'none';
                return json;
            } catch(e) {
                document.getElementById('loading').style.display = 'none';
                alert('é€£ç·šéŒ¯èª¤');
                return { success: false };
            }
        }
    </script>
</body>
</html>
