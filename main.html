<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨˜å¸³å°å¹«æ‰‹</title>
  <base target="_top">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary: #4e54c8; --bg: #f4f6f9; --text: #2f3542; }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
    
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ç¯©é¸å™¨æ¨£å¼ */
    .filter-bar {
      background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;
      border: 1px solid #eee; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .filter-item { display: flex; align-items: center; gap: 5px; }
    .filter-label { font-size: 14px; color: #666; font-weight: bold; }
    .filter-input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .btn-search { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .btn-search:hover { opacity: 0.9; }

    /* Modal ç›¸é—œ */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-box { background: white; padding: 25px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s; position: relative; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .status-modal .icon-box { width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; }
    .success .icon-box { background: #e3f9e5; color: #28a745; border: 2px solid #28a745; }
    .error .icon-box { background: #fdecea; color: #dc3545; border: 2px solid #dc3545; }
    .confirm .icon-box { background: #fff3cd; color: #ffc107; border: 2px solid #ffc107; }
    .edit-modal-box { width: 350px; text-align: left; }
    .edit-modal-box h3 { margin-top: 0; text-align: center; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .edit-form-grid { display: grid; gap: 10px; margin-top: 15px; }
    .modal-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #333; }
    .modal-msg { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
    .modal-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px;}
    .modal-btn { background: #4e54c8; color: white; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; flex: 1; font-size: 14px; }
    .modal-btn.cancel { background: #e0e0e0; color: #333; }

    /* Layout */
    .header { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header h1 { margin: 0; font-size: 20px; color: var(--primary); }
    .btn-logout { background: #ced6e0; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; }
    .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
    .nav { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid #e1e1e1; }
    .nav button { padding: 12px 25px; cursor: pointer; background: transparent; border: none; font-size: 16px; color: #999; position: relative; font-family: inherit; font-weight: bold; }
    .nav button.active { color: var(--primary); }
    .nav button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary); }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
    @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #eee; }
    h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #555; }
    .form-grid { display: grid; gap: 12px; }
    input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
    .btn-submit { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
    .table-container { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; color: #666; padding: 15px; text-align: left; font-size: 13px; }
    td { padding: 15px; border-bottom: 1px solid #f1f2f6; font-size: 14px; color: #333; }
    .btn-action { border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px; }
    .btn-edit { background: #ffeaa7; color: #d35400; }
    .btn-del { background: #fab1a0; color: #c0392b; }
    .chip { background: #e0e6ed; padding: 4px 10px; border-radius: 15px; font-size: 12px; margin-right: 5px; display: inline-block; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div id="loading-overlay"><div class="spinner"></div></div>

  <div class="modal-overlay" id="statusModal">
    <div class="modal-box status-modal" id="modalContent">
      <div class="icon-box" id="modalIcon"></div>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-msg" id="modalMsg"></div>
      <div class="modal-btn-group">
         <button class="modal-btn" onclick="closeStatusModal()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="personalEditModal">
    <div class="modal-box edit-modal-box">
      <h3>âœ ä¿®æ”¹å€‹äººç´€éŒ„</h3>
      <div class="edit-form-grid">
        <input type="hidden" id="edit_p_id">
        <label style="font-size:12px; color:#666;">æ—¥æœŸ</label>
        <input type="date" id="edit_p_date">
        <label style="font-size:12px; color:#666;">é¡åˆ¥</label>
        <select id="edit_p_cat">
           <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option>
           <option value="äº¤é€š">ğŸš— äº¤é€š</option>
           <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
           <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
           <option value="å…¶ä»–">ğŸ“„ å…¶ä»–</option>
        </select>
        <label style="font-size:12px; color:#666;">é‡‘é¡</label>
        <input type="number" id="edit_p_amt" placeholder="é‡‘é¡">
        <label style="font-size:12px; color:#666;">å‚™è¨»</label>
        <input type="text" id="edit_p_note" placeholder="å‚™è¨»">
      </div>
      <div class="modal-btn-group">
        <button class="modal-btn cancel" onclick="closeEditModal('personal')">å–æ¶ˆ</button>
        <button class="modal-btn" onclick="submitPersonalEdit()">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="groupEditModal">
    <div class="modal-box edit-modal-box">
      <h3>âœ ä¿®æ”¹åœ˜é«”ç´€éŒ„</h3>
      <div class="edit-form-grid">
        <input type="hidden" id="edit_g_id">
        <label style="font-size:12px; color:#666;">æ—¥æœŸ</label>
        <input type="date" id="edit_g_date">
        <label style="font-size:12px; color:#666;">é¡åˆ¥</label>
        <select id="edit_g_cat">
           <option>é£²é£Ÿ</option><option>äº¤é€š</option><option>å¨›æ¨‚</option><option>å…¬è²»</option>
        </select>
        <label style="font-size:12px; color:#666;">é‡‘é¡</label>
        <input type="number" id="edit_g_amt" placeholder="é‡‘é¡">
        <label style="font-size:12px; color:#666;">å‚™è¨»</label>
        <input type="text" id="edit_g_note" placeholder="å‚™è¨»">
      </div>
      <div class="modal-btn-group">
        <button class="modal-btn cancel" onclick="closeEditModal('group')">å–æ¶ˆ</button>
        <button class="modal-btn" onclick="submitGroupEdit()">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ’° è¨˜å¸³å°å¹«æ‰‹</h1>
    <div>
      <span style="font-size:14px; color:#666; margin-right:10px;" id="welcomeMsg"></span>
      <button onclick="logout()" class="btn-logout">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <div class="nav">
      <button onclick="showTab('personal')" class="active" id="tab-p">å€‹äººè¨˜å¸³</button>
      <button onclick="showTab('group')" id="tab-g">åœ˜é«”è¨˜å¸³</button>
    </div>

    <div id="personal" class="section active">
      
      <div class="filter-bar">
        <span style="color:#4e54c8; font-weight:bold;">ğŸ“… ç¯©é¸æ™‚æ®µ</span>
        <div class="filter-item">
          <span class="filter-label">èµ·ï¼š</span>
          <input type="date" id="p_filter_start" class="filter-input">
        </div>
        <div class="filter-item">
          <span class="filter-label">è¿„ï¼š</span>
          <input type="date" id="p_filter_end" class="filter-input">
        </div>
        <button class="btn-search" onclick="loadPersonalData()">ğŸ” æŸ¥è©¢</button>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h3>âœï¸ æ–°å¢å€‹äººç´€éŒ„</h3>
          <div class="form-grid">
            <input type="date" id="p_date">
            <select id="p_cat">
              <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option>
              <option value="äº¤é€š">ğŸš— äº¤é€š</option>
              <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
              <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
              <option value="å…¶ä»–">ğŸ“„ å…¶ä»–</option>
            </select>
            <input type="number" id="p_amt" placeholder="é‡‘é¡">
            <input type="text" id="p_note" placeholder="å‚™è¨»">
            <button onclick="addPersonal()" class="btn-submit">æ–°å¢ç´€éŒ„</button>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ“Š å€‹äººçµ±è¨ˆ</h3>
          <div id="chart_div" style="width: 100%; height: 250px;"></div>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="p_list"></tbody>
        </table>
      </div>
    </div>

    <div id="group" class="section">
      <div class="card" style="margin-bottom: 20px;">
        <h3>ğŸ‘¥ åœ˜é«”ç®¡ç†</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <input type="text" id="new_group_name" placeholder="æ–°åœ˜é«”åç¨±" style="flex:1">
          <button onclick="createNewGroup()" class="btn-submit" style="width:auto;">å»ºç«‹</button>
        </div>
        <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
          <select id="group_select" onchange="handleGroupChange()"></select>
          <div id="member_area" style="display:none; margin-top:15px;">
             <div style="font-size:12px; color:#888; margin-bottom:5px;">æˆå“¡åå–®ï¼š</div>
             <div id="member_list"></div>
             <div style="display:flex; gap:10px; margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
               <input type="text" id="add_mem_name" placeholder="è¼¸å…¥å°æ–¹çš„ç”¨æˆ¶å" style="flex:1">
               <button onclick="addMember()" class="btn-submit" style="width:auto; padding:8px 15px;">åŠ å…¥</button>
             </div>
          </div>
        </div>
      </div>

      <div class="filter-bar" id="group_filter_area" style="display:none;">
        <span style="color:#4e54c8; font-weight:bold;">ğŸ“… ç¯©é¸æ™‚æ®µ</span>
        <div class="filter-item">
          <span class="filter-label">èµ·ï¼š</span>
          <input type="date" id="g_filter_start" class="filter-input">
        </div>
        <div class="filter-item">
          <span class="filter-label">è¿„ï¼š</span>
          <input type="date" id="g_filter_end" class="filter-input">
        </div>
        <button class="btn-search" onclick="loadGroupData()">ğŸ” æŸ¥è©¢</button>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h3>ğŸ“ æ–°å¢åœ˜é«”ç´€éŒ„</h3>
          <div class="form-grid">
            <input type="date" id="g_date">
            <select id="g_cat"><option>é£²é£Ÿ</option><option>äº¤é€š</option><option>å¨›æ¨‚</option><option>å…¬è²»</option></select>
            <input type="number" id="g_amt" placeholder="é‡‘é¡">
            <input type="text" id="g_note" placeholder="å‚™è¨»">
            <button onclick="addGroupRec()" class="btn-submit">æ–°å¢ç´€éŒ„</button>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ“Š åœ˜é«”çµ±è¨ˆ</h3>
          <div id="group_chart_div" style="width: 100%; height: 250px;"></div>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>æ—¥æœŸ</th><th>æˆå“¡</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="g_list"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // â˜…â˜…â˜… ä½ çš„ GAS API ç¶²å€ â˜…â˜…â˜…
  const API_URL = "https://script.google.com/macros/s/AKfycbz8-1i4zy20ChiZm1lzafRQo18iTiHN0eYzQnj-B3dQY8AjUgMnyEsEdlwmVV516K2V/exec";

  // API å‘¼å«çš„é€šç”¨å‡½å¼
  function callAPI(payload) {
    return fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
      },
      body: JSON.stringify(payload),
    }).then(res => res.json());
  }

  var curAcc = localStorage.getItem('currentAccount');
  var curName = localStorage.getItem('currentUsername');

  if(!curAcc || !curName) { 
    // æœªç™»å…¥å‰‡å›åˆ°é¦–é  (index.html)
    window.location.href = "index.html";
  } else { 
    document.getElementById('welcomeMsg').innerText = 'Hi, ' + curName; 
  }

  google.charts.load('current', {'packages':['corechart']});

  // --- Helper Functions ---
  function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
  
  function showPopup(type, title, msg, callback) {
    var overlay = document.getElementById('statusModal');
    var content = document.getElementById('modalContent');
    var icon = document.getElementById('modalIcon');
    content.className = 'modal-box status-modal ' + type;
    icon.innerHTML = type === 'success' ? 'âœ”' : (type === 'error' ? 'âœ˜' : '?');
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalMsg').innerText = msg;
    overlay.style.display = 'flex';
    var btn = overlay.querySelector('.modal-btn');
    btn.onclick = function() { closeStatusModal(); if(callback) callback(); };
  }

  function confirmPopup(msg, yesCallback) {
     var overlay = document.getElementById('statusModal');
     var content = document.getElementById('modalContent');
     var icon = document.getElementById('modalIcon');
     content.className = 'modal-box status-modal confirm';
     icon.innerHTML = '!';
     document.getElementById('modalTitle').innerText = "ç¢ºèªæ“ä½œ";
     document.getElementById('modalMsg').innerText = msg;
     var btnGroup = content.querySelector('.modal-btn-group');
     btnGroup.innerHTML = `<button class="modal-btn cancel" onclick="closeStatusModal()">å–æ¶ˆ</button><button class="modal-btn" id="confirmYesBtn">ç¢ºå®š</button>`;
     overlay.style.display = 'flex';
     document.getElementById('confirmYesBtn').onclick = function() { closeStatusModal(); yesCallback(); };
  }

  function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    var btnGroup = document.querySelector('#statusModal .modal-btn-group');
    btnGroup.innerHTML = '<button class="modal-btn" onclick="closeStatusModal()">ç¢ºå®š</button>';
  }
  function closeEditModal(type) {
    if(type === 'personal') document.getElementById('personalEditModal').style.display = 'none';
    if(type === 'group') document.getElementById('groupEditModal').style.display = 'none';
  }

  // --- åˆå§‹åŒ– ---
  window.onload = function() {
    if(!curAcc) return; // é¿å…æœªç™»å…¥æ™‚åŸ·è¡Œä¸‹æ–¹é‚è¼¯
    showTab('personal');
    
    // è¨­å®šé è¨­æ—¥æœŸ (ä»Šå¤©)
    var today = new Date();
    document.getElementById('p_date').valueAsDate = today;
    document.getElementById('g_date').valueAsDate = today;
    
    // è¨­å®šç¯©é¸å™¨é è¨­å€¼ (æœ¬æœˆ1è™Ÿ ~ ä»Šå¤©)
    var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    var formatDate = (d) => d.toISOString().split('T')[0];
    
    document.getElementById('p_filter_start').value = formatDate(firstDay);
    document.getElementById('p_filter_end').value = formatDate(today);
    document.getElementById('g_filter_start').value = formatDate(firstDay);
    document.getElementById('g_filter_end').value = formatDate(today);

    loadPersonalData();
    loadMyGroups();
  };

  function logout() {
    localStorage.clear();
    window.location.href = "index.html";
  }

  function showTab(id) {
    document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById(id === 'personal' ? 'tab-p' : 'tab-g').classList.add('active');
  }

  // --- å€‹äººåŠŸèƒ½ ---
  function loadPersonalData() {
    showLoading(true);
    var start = document.getElementById('p_filter_start').value;
    var end = document.getElementById('p_filter_end').value;

    callAPI({
      action: 'getPersonalRecords',
      account: curAcc,
      startDate: start,
      endDate: end
    })
    .then(data => {
      var html = '';
      if(!data.records || data.records.length === 0) html = '<tr><td colspan="5" style="text-align:center; color:#999;">æ­¤å€é–“ç„¡è³‡æ–™</td></tr>';
      else {
        data.records.forEach(r => {
          html += `<tr><td>${r.date}</td><td>${r.cat}</td><td>$${r.amt}</td><td>${r.note}</td>
          <td><button class="btn-action btn-edit" onclick="openEditP('${r.id}','${r.date}','${r.cat}','${r.amt}','${r.note}')">âœ</button>
          <button class="btn-action btn-del" onclick="delP('${r.id}')">ğŸ—‘</button></td></tr>`;
        });
      }
      document.getElementById('p_list').innerHTML = html;
      drawChart(data.chartData, 'chart_div');
      showLoading(false);
    })
    .catch(err => { console.error(err); showLoading(false); });
  }

  function addPersonal() {
    showLoading(true);
    var data = { 
      account: curAcc, 
      date: document.getElementById('p_date').value, 
      category: document.getElementById('p_cat').value, 
      amount: document.getElementById('p_amt').value, 
      note: document.getElementById('p_note').value 
    };
    
    callAPI({ action: 'addPersonalRecord', data: data })
    .then(() => { 
      showLoading(false);
      showPopup('success', 'æˆåŠŸ', 'å·²æ–°å¢ä¸€ç­†ç´€éŒ„', () => {
         document.getElementById('p_amt').value = ''; 
         document.getElementById('p_note').value = '';
         loadPersonalData();
      });
    });
  }

  function openEditP(id, date, cat, amt, note) {
    document.getElementById('edit_p_id').value = id;
    document.getElementById('edit_p_date').value = date;
    document.getElementById('edit_p_cat').value = cat;
    document.getElementById('edit_p_amt').value = amt;
    document.getElementById('edit_p_note').value = note;
    document.getElementById('personalEditModal').style.display = 'flex';
  }

  function submitPersonalEdit() {
    var id = document.getElementById('edit_p_id').value;
    var data = { 
      date: document.getElementById('edit_p_date').value, 
      category: document.getElementById('edit_p_cat').value, 
      amount: document.getElementById('edit_p_amt').value, 
      note: document.getElementById('edit_p_note').value 
    };
    closeEditModal('personal');
    showLoading(true);
    
    callAPI({ action: 'updatePersonalRecord', id: id, data: data })
    .then(() => {
      showLoading(false);
      showPopup('success', 'ä¿®æ”¹æˆåŠŸ', 'ç´€éŒ„å·²æ›´æ–°', () => loadPersonalData());
    });
  }

  function delP(id) { 
    confirmPopup('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ', function(){
      showLoading(true); 
      callAPI({ action: 'deletePersonalRecord', id: id })
      .then(() => {
        showLoading(false);
        showPopup('success', 'åˆªé™¤æˆåŠŸ', '', () => loadPersonalData());
      }); 
    });
  }

  // --- åœ˜é«”åŠŸèƒ½ ---
  function createNewGroup() {
    var name = document.getElementById('new_group_name').value;
    if(!name) return showPopup('error', 'éŒ¯èª¤', 'è«‹è¼¸å…¥åœ˜é«”åç¨±');
    showLoading(true);
    
    callAPI({ action: 'createGroup', groupName: name, creatorUsername: curName })
    .then(() => { 
      showLoading(false);
      showPopup('success', 'å»ºç«‹æˆåŠŸ', 'åœ˜é«” ' + name + ' å·²å»ºç«‹', () => loadMyGroups());
    });
  }

  function loadMyGroups() {
    callAPI({ action: 'getMyGroups', currentUsername: curName })
    .then(res => {
      var sel = document.getElementById('group_select');
      sel.innerHTML = '<option value="">â–¼ é¸æ“‡åœ˜é«”</option>';
      if(res.data) {
          res.data.forEach(g => { sel.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
      }
    });
  }

  function handleGroupChange() {
    var gid = document.getElementById('group_select').value;
    var memArea = document.getElementById('member_area');
    var filterArea = document.getElementById('group_filter_area');
    
    if(!gid) { 
      memArea.style.display = 'none'; 
      filterArea.style.display = 'none';
      return; 
    }
    memArea.style.display = 'block';
    filterArea.style.display = 'flex';
    loadGroupMembers(gid);
    loadGroupData(gid);
  }

  function loadGroupMembers(gid) {
    callAPI({ action: 'getGroupMembers', groupId: gid })
    .then(res => {
      var html = '';
      if(res.data) {
          res.data.split(',').forEach(m => html += `<span class="chip">ğŸ‘¤ ${m.trim()}</span>`);
      }
      document.getElementById('member_list').innerHTML = html;
    });
  }

  function addMember() {
    var gid = document.getElementById('group_select').value;
    var target = document.getElementById('add_mem_name').value;
    if(!gid || !target) return showPopup('error', 'éŒ¯èª¤', 'è«‹è¼¸å…¥ç”¨æˆ¶å');
    showLoading(true);
    
    callAPI({ 
      action: 'addMemberToGroup', 
      groupId: gid, 
      targetUsername: target, 
      requestingUsername: curName 
    })
    .then(res => {
      showLoading(false);
      if(res.status === 'success') showPopup('success', 'æˆåŠŸ', res.msg, () => { loadGroupMembers(gid); document.getElementById('add_mem_name').value = ''; });
      else showPopup('error', 'å¤±æ•—', res.msg);
    });
  }

  function loadGroupData(gid) {
    if(!gid) gid = document.getElementById('group_select').value;
    if(!gid) return;
    
    var start = document.getElementById('g_filter_start').value;
    var end = document.getElementById('g_filter_end').value;

    showLoading(true);
    callAPI({ 
      action: 'getGroupRecords', 
      groupId: gid, 
      requestingUsername: curName, 
      startDate: start, 
      endDate: end 
    })
    .then(data => {
      var html = '';
      if(!data.records || data.records.length === 0) html = '<tr><td colspan="6" style="text-align:center;">æ­¤å€é–“ç„¡è³‡æ–™</td></tr>';
      else {
        data.records.forEach(r => {
          html += `<tr><td>${r.date}</td><td><span class="chip" style="background:white; border:1px solid #eee">${r.user}</span></td>
          <td>${r.cat}</td><td>$${r.amt}</td><td>${r.note}</td>
          <td><button class="btn-action btn-edit" onclick="openEditG('${r.id}','${r.date}','${r.cat}','${r.amt}','${r.note}')">âœ</button>
          <button class="btn-action btn-del" onclick="delG('${r.id}')">ğŸ—‘</button></td></tr>`;
        });
      }
      document.getElementById('g_list').innerHTML = html;
      drawChart(data.chartData, 'group_chart_div');
      showLoading(false);
    });
  }

  function addGroupRec() {
    var gid = document.getElementById('group_select').value;
    if(!gid) return showPopup('error', 'éŒ¯èª¤', 'è«‹å…ˆé¸æ“‡åœ˜é«”');
    showLoading(true);
    
    var data = { 
      groupId: gid, 
      user: curName, 
      date: document.getElementById('g_date').value, 
      category: document.getElementById('g_cat').value, 
      amount: document.getElementById('g_amt').value, 
      note: document.getElementById('g_note').value 
    };
    
    callAPI({ action: 'addGroupRecord', data: data })
    .then(() => { 
      showLoading(false);
      showPopup('success', 'æˆåŠŸ', 'åœ˜é«”ç´€éŒ„å·²æ–°å¢', () => {
         document.getElementById('g_amt').value = ''; 
         document.getElementById('g_note').value = '';
         loadGroupData(gid); 
      });
    });
  }

  function openEditG(id, date, cat, amt, note) {
    document.getElementById('edit_g_id').value = id;
    document.getElementById('edit_g_date').value = date;
    document.getElementById('edit_g_cat').value = cat;
    document.getElementById('edit_g_amt').value = amt;
    document.getElementById('edit_g_note').value = note;
    document.getElementById('groupEditModal').style.display = 'flex';
  }

  function submitGroupEdit() {
    var gid = document.getElementById('group_select').value;
    var id = document.getElementById('edit_g_id').value;
    var data = { 
      date: document.getElementById('edit_g_date').value, 
      category: document.getElementById('edit_g_cat').value, 
      amount: document.getElementById('edit_g_amt').value, 
      note: document.getElementById('edit_g_note').value 
    };
    closeEditModal('group');
    showLoading(true);
    
    callAPI({ action: 'updateGroupRecord', id: id, data: data })
    .then(() => {
      showLoading(false);
      showPopup('success', 'ä¿®æ”¹æˆåŠŸ', 'åœ˜é«”ç´€éŒ„å·²æ›´æ–°', () => loadGroupData(gid));
    });
  }

  function delG(id) { 
    confirmPopup('ç¢ºå®šåˆªé™¤æ­¤åœ˜é«”ç´€éŒ„?', function(){
      showLoading(true); 
      callAPI({ action: 'deleteGroupRecord', id: id })
      .then(() => {
        showLoading(false);
        showPopup('success', 'åˆªé™¤æˆåŠŸ', '', () => loadGroupData());
      });
    });
  }

  function drawChart(arr, id) {
    if(!arr || arr.length <= 1) { document.getElementById(id).innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ccc;">ç„¡æ•¸æ“š</div>'; return; }
    new google.visualization.PieChart(document.getElementById(id)).draw(google.visualization.arrayToDataTable(arr), { pieHole: 0.4, chartArea: {width:'90%',height:'80%'}, legend:{position:'bottom'} });
  }
</script>
</body>
</html>
</html>
